<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contatore Visitatori - UniFinder</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-image: url('Imgs/cambridge.jpg'); /* Immagine di sfondo */
            background-size: cover; /* Coprire l'intera area */
            background-position: center; /* Centrare l'immagine */
            background-repeat: no-repeat; /* Non ripetere l'immagine */
        }
        
        #contatore-container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 10px;
            margin: 50px auto;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        
        .contatore-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #4CAF50;
        }
        
        .numero-visitatori {
            font-size: 4rem;
            font-weight: bold;
            color: #4CAF50;
            margin: 20px 0;
            display: block;
        }
        
        .etichetta-visitatori {
            font-size: 1.5rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .aggiornamento-tempo {
            font-size: 0.9rem;
            color: #777;
            margin-top: 10px;
        }
        
        .stato-connessione {
            padding: 8px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .connesso {
            background-color: #d4edda;
            color: #155724;
        }
        
        .disconnesso {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

    <header>
        <nav>
            <h1>UniFinder</h1>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#registrazione">Registrazione</a></li>
                <li><a href="login.html">Login</a></li>
                <li><a href="ajax.html">AJAX</a></li>
                <li><a href="WebSocket.html">WebSocket</a></li>
                <li><a href="chat.html">Chat Assistenza</a></li>
                <li><a href="index.html#ricerca-universita">Ricerca Università</a></li>
                <li><a href="Privacy.html">Privacy</a></li>
                <li><a href="Terms.html">Termini e Condizioni</a></li>
            </ul>
        </nav>
    </header>

    <!-- Contatore Visitatori -->
    <section id="contatore-container">
        <h2>Contatore Visitatori in Tempo Reale</h2>
        
        <div class="contatore-box">
            <div class="etichetta-visitatori">Utenti attualmente online:</div>
            <span id="contatore-visitatori" class="numero-visitatori">0</span>
            <div class="aggiornamento-tempo">Aggiornato in tempo reale</div>
            <div id="stato-connessione" class="stato-connessione disconnesso">
                Connessione al server...
            </div>
        </div>
        
        <p>Questo contatore mostra il numero di visitatori attualmente connessi al sito UniFinder in tempo reale. Il conteggio viene aggiornato automaticamente quando gli utenti si connettono o si disconnettono.</p>
    </section>

    <footer>
        <p>&copy; 2024 UniFinder | All rights reserved | 5ic</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const contatoreVisitatori = document.getElementById('contatore-visitatori');
            const statoConnessione = document.getElementById('stato-connessione');
            
            // Configura WebSocket
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const wsUrl = `${wsProtocol}//${window.location.host}`;
            let socket;
           let tentativi = 0;
const maxTentativi = 5;
            
            // Funzione per stabilire la connessione WebSocket
            function connetti() {
    socket = new WebSocket(wsUrl);
    
    // Quando la connessione WebSocket è aperta
    socket.onopen = function() {
        console.log('Connessione WebSocket stabilita');
        tentativi = 0;
        statoConnessione.textContent = 'Connesso al server';
        statoConnessione.className = 'stato-connessione connesso';
    };
    
    // Quando si riceve un messaggio dal server
    socket.onmessage = function(event) {
        try {
            const messaggio = JSON.parse(event.data);
            
            // Se il messaggio contiene il conteggio dei visitatori, aggiorna il contatore
            if (messaggio.tipo === 'contatore-visitatori') {
                contatoreVisitatori.textContent = messaggio.conteggio;
                // Aggiungi un'animazione per evidenziare il cambiamento
                contatoreVisitatori.style.transition = 'color 0.3s ease';
                contatoreVisitatori.style.color = '#ff9800';
                setTimeout(() => {
                    contatoreVisitatori.style.color = '#4CAF50';
                }, 300);
            }
        } catch (error) {
            console.error('Errore nel parsing del messaggio WebSocket:', error);
        }
    };
    
    // Quando si chiude la connessione
    socket.onclose = function() {
        console.log('Connessione WebSocket chiusa');
        statoConnessione.textContent = 'Disconnesso dal server. Tentativo di riconnessione...';
        statoConnessione.className = 'stato-connessione disconnesso';
        
        // Riprova a connettersi dopo un po' di tempo, ma limita i tentativi
        if (tentativi < maxTentativi) {
            tentativi++;
            setTimeout(connetti, 5000); // Riprova dopo 5 secondi
        } else {
            statoConnessione.textContent = 'Impossibile connettersi al server. Ricarica la pagina per riprovare.';
        }
    };
    
    // Quando si verifica un errore
    socket.onerror = function(error) {
        console.error('Errore WebSocket:', error);
        statoConnessione.textContent = 'Errore di connessione al server';
        statoConnessione.className = 'stato-connessione disconnesso';
    };
}

// Avvia la connessione WebSocket
connetti();

            
            // Invia un messaggio di disconnessione quando l'utente lascia la pagina
            window.addEventListener('beforeunload', function() {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        tipo: 'disconnessione',
                        pagina: 'visitatori'
                    }));
                }
            });
        });
    </script>
</body>
</html>